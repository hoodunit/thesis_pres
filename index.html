<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">

	<title>Clojure on Android</title>

	<meta name="description" content="">
	<meta name="author" content="">

	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

	<link rel="stylesheet" href="css/reveal.css">
	<link rel="stylesheet" href="css/theme/black.css" id="theme">

	<!-- Code syntax highlighting -->
	<link rel="stylesheet" href="lib/css/zenburn.css">
	<link rel="stylesheet" href="css/ownstyles.css">

	<!-- Printing and PDF exports -->
	<script>
		var link = document.createElement( 'link' );
		link.rel = 'stylesheet';
		link.type = 'text/css';
		link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
		document.getElementsByTagName( 'head' )[0].appendChild( link );
	</script>

	<!--[if lt IE 9]>
	<script src="lib/js/html5shiv.js"></script>
	<![endif]-->
</head>

<body>
<div class="reveal">
	<div class="slides">

		<section>
			<h1>Clojure on Android</h1>
			<h3>Nicholas Kariniemi - Master's Thesis</h3>
			<img class="normal-image" data-src="img/clojure_plus_android.png" />
            <small>
            Aalto University 2015.4.10 <br/>
            Supervisor: Professor Jukka Nurminen<br/>
            Advisor: Dr. Vesa Hirvisalo<br/>
            </small>
			<br/>
		</section>

		<section>
			<h3>What I'm talking about</h3>
			<ul>
				<li class="fragment">The <span class="green">Why</span> of Clojure on Android</li>
				<li class="fragment">The <span class="red">Why Not</span> of Clojure on Android</li>
				<ul>
					<li class="fragment">Benchmarking results</li>
					<li class="fragment">Explanation</li>
				</ul>
				<li class="fragment">Lean Clojure on Android</li>
				<ul>
                    <li class="fragment">The Big Idea</li>
					<li class="fragment">Benchmarking results</li>
                </ul>
				<li class="fragment">Conclusions: The State of Clojure on Android</li>
			</ul>
		</section>

		<section>
			<h3>Why Clojure on Android?</h3>
		</section>

		<section>
			<h3>Why Android?</h3>
			<ul>
				<li class="fragment">Most widely used mobile OS</li>
				<li class="fragment">Likely to grow with Internet of Things</li>
			</ul>
			<img class="normal-image" data-src="img/android_logo.png" />
		</section>

        <section data-transition="slide" data-background="#b5533c" data-background-transition="zoom">
			<h1>iOS</h1>
			<img class="normal-image" data-src="img/swift_logo.png" />
			<h2>Swift</h2>
			<small><blockquote>
				Swift is an innovative new programming language for Cocoa and Cocoa Touch. Writing code is interactive and fun, the syntax is concise yet expressive, and apps run lightning-fast. Swift is ready for your next iOS and OS X project — or for addition into your current app — because Swift code works side-by-side with Objective-C.
			</blockquote></small>
		</section>

        <section data-transition="slide" data-background="#333333" data-background-transition="zoom">
			<h1>Windows Phone</h1>
			<div style="font-size: 180px; color: #30B9DB">F#</div>
			<small><blockquote>
				F# is a mature, open source, cross-platform, functional-first programming language. It empowers users and organizations to tackle complex computing problems with simple, maintainable and robust code.
			</blockquote></small>
		</section>

        <section data-transition="slide" data-background="white" data-background-transition="zoom">
			<h1>Android</h1>
			<img class="normal-image" data-src="img/java7.jpg" />
			<small><blockquote>
			</blockquote></small>
		</section>

		<section data-background="white">
			<h4>Android development uses an outdated language.</h4>
			<h4 class="fragment">There are no officially-supported alternatives.</h4>
		</section>

        <section data-transition="slide" data-background-color="#222222" data-background-transition="zoom">
			<h3>How about <span class="blue">Clojure</span>?</h3>
			<img style="width: 30%" class="normal-image" data-src="img/clojure_logo.png" />
		</section>

		<section>
			<h2><span class="blue">Clojure</span>
				<span class="fragment">: a functional</span><span class="fragment">, dynamic</span><span class="fragment">, Lisp</span><span class="fragment"> with good concurrency support</span><span class="fragment"> that runs on the JVM</span></h2>
		</section>

		<section>
			<h3><span class="blue">Why Clojure on Android?</span></h3>
        </section>

		<section>
			<h4><span class="blue">Why Clojure on Android?</span> Clojure plays nice with Java</h4>
			<pre><code data-trim>
(ns com.android.helloworld.HelloWorld
  (:gen-class
   :extends android.app.Activity
   :exposes-methods {onCreate superOnCreate})
  (:import [android.app Activity]
           [android.os Bundle]))

(defn -onCreate [this #^android.os.Bundle bundle]
  (.superOnCreate this bundle)
  (.setContentView this com.android.helloworld.R$layout/main))
			</code></pre>
			<ul>
				<li class="fragment">Clojure compiles to JVM bytecode like Java</li>
				<li class="fragment">and has good interop with Java</li>
			</ul>
		</section>

		<section>
            <section>
			<h4><span class="blue">Why Clojure on Android?</span> Functional goodness</h4>
			<pre><code data-trim>
(defn fetch-users []
  (->> users
       Observable/from
       (rx/drop 1)
       (rx/map clojure.string/lower-case)
       (rx/map (fn [v] {:id 1234 :name v}))
       (rx/map to-json)))
			</code></pre>
			</section>

			<section>
				<h3>Android Java: Verbose anonymous classes</h3>
				<small>
			<pre style="width: 100%;"><code java data-trim>
public static Observable fetchUsers(){
    return Observable.from(userNames)
        .skip(1)
        .map(new Func1&lt;String, String&gt;() {
            @Override
            public String call(String userName){
            return userName.toLowerCase();
            }
        })
        .map(new Func1&lt;String, HashMap&lt;String, String&gt;&gt;() {
            @Override
            public HashMap&lt;String, String&gt; call(String userName){
                HashMap&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();
                map.put("id", "1234");
                map.put("name", userName);
            return map;
            }
        })
        .map(new Func1&lt;HashMap&lt;String, String&gt;, String&gt;() {
            @Override
            public String call(HashMap&lt;String, String&gt; userData){
                return toJson(userData);
            }
        });
    }
			</code></pre>
					</small>
			</section>
		</section>

		<section>
			<section>
			<h4><span class="blue">Why Clojure on Android?</span> Data as code</h4>
            <code><pre>
(def main-view
    [:linear-layout {:orientation :vertical}
     [:linear-layout {:orientation :horizontal}
       [:text-view {:text "Location: "}]
       [:text-view {:def `location-text :text ""}]]
    [:linear-layout {:orientation :horizontal}
     [:text-view {:text "Signal strength: "}]
     [:text-view {:def `strength-text :text ""}]]
     [:linear-layout {:orientation :horizontal}
      [:text-view {:text "Carrier: "}]
      [:text-view {:def `carrier-text :text ""}]]])

(defactivity org.antenna.MainActivity
    :def main-activity
    :on-create (fn [this bundle]
        (on-ui (set-content-view! main-activity (make-ui main-view)))
        (display-and-send-current-data main-activity)))
			</code></pre>
				</section>
			<section>
				<h4>Android Java: XML + extended Java classes</h4>
				<small>
				<code><pre>
&lt;FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
			 android:id="@+id/contactinfoview"
			 android:layout_width="match_parent"
			 android:layout_height="match_parent"
			 android:gravity="center"
			 android:clickable="true"
			 android:background="@color/tb_background_grey"
			 android:orientation="vertical">
	&lt;LinearLayout
			android:layout_width="match_parent"
			android:layout_height="wrap_content"
			android:orientation="vertical">
		&lt;LinearLayout
				android:id="@+id/upperlayout"
				android:layout_width="match_parent"
				android:layout_height="wrap_content">
			&lt;LinearLayout
					android:layout_width="match_parent"
					android:layout_height="wrap_content"
					android:layout_marginTop="71dp"
					android:layout_marginLeft="228dp"
					android:layout_marginRight="228dp"
					android:orientation="horizontal">
				&lt;FrameLayout
						android:layout_width="140dp"
						android:layout_height="114dp">
					...
				</code></pre></small>
			</section>
		</section>

		<section>
			<h3><span class="blue">Why Clojure on Android?</span></h3>
			<ul>
				<li class="fragment">Immutability as default + immutable data structures</li>
				<li class="fragment">Sensible concurrency: STM, core.async</li>
				<li class="fragment">Dynamic development</li>
			</ul>
        </section>

		<section>
			OK, Clojure on Android is awesome. Let's try it!
		</section>

		<section>
			Hello Clojure on Android
			<pre><code data-trim>
(ns com.android.helloworld.HelloWorld
  (:gen-class
   :extends android.app.Activity
   :exposes-methods {onCreate superOnCreate})
  (:import [android.app Activity]
           [android.os Bundle]))

(defn -onCreate [this #^android.os.Bundle bundle]
  (.superOnCreate this bundle)
  (.setContentView this com.android.helloworld.R$layout/main))
			</code></pre>
		</section>

		<section data-background="white">
			<img class="normal-image" data-src="img/android_loader.gif" />
		</section>

		<section data-background="white">
			<img class="normal-image" data-src="img/android_loader.gif" />
		</section>

		<section>
		<section>
			Startup time is a problem.
		</section>

		<section>
			<h3>What do you think is Clojure's most glaring weakness / blind spot / problem?</h3>
			<p>
				2013 State of Clojure Survey (Chas Emerick)
			</p>
		</section>

		<section>
			<ul style="font-size: 30px;">
				<h3>2013 State of Clojure Survey Responses</h3>
				<li>slow start-up time of jvm</li>
				<li>JVM Prejudice, I used to have such against Java. JVM startup time still sucks</li>
				<li>its usefulness in many potential applications is limited by the jvm's startup time</li>
				<li>start up time and deployed package size (these are related, and not just the jvm's fault)</li>
				<li>That damn jvm startup time</li>
				<li>It's partly because of the JVM, but clojure programs are really slow to start</li>
				<li>JVM startup overhead, documentation</li>
				<li>JVM bootstrap time</li>
				<li>Language runtime bootstrapping takes way too much time, which renders the
					otherwise desirable scripting story impractical.</li>
				<li>Startup time for quick scripts (and I'm not a fan of the various 'hot JVM' solutions)</li>
			</ul>
		</section>

		<section>
			<p>Alex Miller analysis of 2013 State of Clojure survey:</p>
			<p>
				<span class="fragment highlight-blue">"By far the largest subset of performance-related complaints were about JVM
				startup time. </span>Phil Hagelberg has also reported that this is one of, perhaps the
				highest, complaint of leiningen users as well.... JVM startup time is never going to go away..., but there are likely still things that can be done to decrease
				Clojure loading time or better control the loading of code"
			</p>
		</section>

		<section data-background="white">
			<img class="normal-image" data-src="img/stackoverflow1.png" />
		</section>

		<section data-background="white">
			<img class="normal-image" data-src="img/stackoverflow2.png" />
		</section>

		<section data-background="white">
			<p>Responses: How to speed up startup time (1)</p>
			<small>
				<ul>
					<li>David Nolen: Try the client JVM.</li>
				</ul>
			</small>
			<img class="normal-image" data-src="img/stackoverflow_response1.png" />
		</section>

		<section data-background="white">
			<p>Responses: How to speed up startup time (2)</p>
			<small>
				<ul>
					<li>Try the client JVM.</li>
					<li>Try warming up Clojure first.</li>
				</ul>
			</small>
			<img class="normal-image" data-src="img/stackoverflow_response2.png" />
		</section>

		<section data-background="white">
			<p>Responses: How to speed up startup time (3)</p>
			<small>
				<ul>
					<li>Try the client JVM.</li>
					<li>Try AOT compilation.</li>
					<li>Try using a persistent JVM.</li>
				</ul>
			</small>
			<img class="normal-image" data-src="img/stackoverflow_response3.png" />
		</section>
		</section>

		<section>
			How much of a problem?
		</section>

		<section>
			Let's benchmark it.
		</section>

		<section>
		<section>
			<h3>Hello World benchmark</h3>
			<pre><code data-trim>
(ns com.android.helloworld.HelloWorld
  (:gen-class
   :extends android.app.Activity
   :exposes-methods {onCreate superOnCreate})
  (:import [android.app Activity]
           [android.os Bundle]))

(defn -onCreate [this #^android.os.Bundle bundle]
  (.superOnCreate this bundle)
  (.setContentView this com.android.helloworld.R$layout/main))
			</code></pre>
			<ul>
				<li class="fragment">Displays a text field with "Hello world"</li>
				<li class="fragment">i.e. does almost nothing (but in Clojure)</li>
			</ul>
		</section>

		<section>
			<h3>Hello World benchmark</h3>
			<pre><code data-trim>
				(ns com.android.helloworld.HelloWorld
				(:gen-class
				:extends android.app.Activity
				:exposes-methods {onCreate superOnCreate})
				(:import [android.app Activity]
				[android.os Bundle]))

				(defn -onCreate [this #^android.os.Bundle bundle]
				(.superOnCreate this bundle)
				(.setContentView this com.android.helloworld.R$layout/main))
			</code></pre>
			<ul>
				<li class="fragment">Displays a text field with "Hello world"</li>
				<li class="fragment">i.e. does almost nothing</li>
			</ul>
		</section>
        </section>

		<section data-background="white">
			<h3>Hello world benchmark: JVM vs Dalvik</h3>
			<div id="startupJvmAndDalvik" class="diagram" />
		</section>

		<section>
			<p>But that's Dalvik. I'll use ART!</p>
			<br/>
			<small class="fragment">(Dalvik is the Android virtual machine for versions up to KitKat/4.4. <br />ART is the new virtual machine starting with Lollipop/5.0.)</small>
		</section>

		<section data-background="white">
			<h3>Hello world benchmark: Dalvik vs ART</h3>
			<div id="startupArt" class="diagram"></div>
		</section>

		<section>
			<p>But that's just one device! Other devices might be faster!</p>
		</section>

		<section data-background="white">
			<h3>Hello world benchmark: Nexus 5 vs Nexus 7</h3>
			<div id="startupOtherDevices" class="diagram"></div>
		</section>

		<section>
			<p>But that's just a silly little hello world app. <br/> Real apps are different!</p>
		</section>

		<section>
			<section data-background="white">
            <h3>Hello vs Dependencies benchmark</h3>
			Hello benchmark:
			<div id="startupOtherAppsHello" class="diagram" style="height: 25%"></div>
			Dependencies benchmark:
			<div id="startupOtherAppsDependencies" class="diagram" style="height: 25%"></div>
			</section>
            <section>
            <h3>Dependencies benchmark</h3>
			<code data-trim><pre>
(ns benchmark.dependencies
  (:gen-class)
  (:require [rx.lang.clojure.core :as rx]
            [rx.lang.clojure.blocking :as rxb]
            [cognitect.transit :as transit]
            clojure.string)
  (import [java.io ByteArrayOutputStream]
          rx.Observable))

(defn to-json [input]
  (let [out (ByteArrayOutputStream. 4096)
        writer (transit/writer out :json)]
    (transit/write writer input)
    (.toString out)))

(def users ["Tom" "Dick" "Harry"])

(defn fetch-users []
  (->> users
       Observable/from
       (rx/drop 1)
       (rx/map clojure.string/lower-case)
       (rx/map (fn [v] {:id 1234 :name v}))
       (rx/map to-json)))

(defn -main [& args]
  (let [users-json (fetch-users)]
    (rxb/doseq [user users-json] (println user))))
			</code></pre>
            </section>
		</section>

		<section>
			<h3>Summary</h3>
			<ul>
				<li class="fragment">Clojure on Android apps start slowly (2s minimum)</li>
				<li class="fragment">...even on ART (1.5s minimum)</li>
				<li class=fragment>...and it scales upwards quickly (deps benchmark: 2-2.7s)</li>
			</ul>
		</section>

		<section data-background="white">
			<h1 style="color: red;">Why?!?!</h1>
			<img class="normal-image" data-src="img/why_meme.png" />
		</section>

		<section>
			Why does Clojure start slowly?
		</section>

		<section>
			<img style="width: 80%;" class="normal-image" data-src="img/hickey_not_awesome.jpg" />
			<p>Rich Hickey, the creator of Clojure <br/> (as quoted by David Nolen)</p>
        </section>

		<section>
			Profile it.
		</section>

        <section data-background="white">
            <h3>Clojure Hello World Breakdown</h3>
            <img class="half-image" data-src="img/clojure_dalvik_breakdown.svg" />
            <img class="half-image" data-src="img/clojure_jvm_breakdown.svg" />
            <ul>
				<li class="fragment">Loading virtual machine: ~6% of time (50-120 ms)</li>
                <li class="fragment">Loading Clojure core: ~80% of time (700-1500 ms)</li>
            </ul>
        </section>

		<section>
			<h3>What is "Clojure core"?</h3>
			<ul>
				<li class="fragment">The Clojure language = mostly functions</li>
				<li class="fragment">Functions are wrapped in vars.</li>
				<ul>
					<li class="fragment">Var: pointer to a value</li>
					<li class="fragment">Vars are dynamic: they can be given new values</li>
				</ul>
				<li class="fragment">Vars are organized by namespaces.</li>
				<li class="fragment">The clojure.core namespace defines most Clojure functions</li>
				<ul>
					<li class="fragment">e.g. when, =, and, or</li>
					<li class="fragment">e.g. basic data structures like vectors, maps, sets</li>
				</ul>
			</ul>
		</section>

		<section>
			<section data-background="white">
				<h3>Why is loading Clojure core so slow?</h3>
				<ul>
					<li class="fragment">You need to set up those vars somewhere.</li>
					<li class="fragment">Clojure sets up vars when a namespace is loaded.</li>
					<li class="fragment">Loading clojure.core namespace bootstraps the language.</li>
				<span class="fragment"><img class="normal-image" data-src="img/namespace_vars.svg" /> </span>
			</ul>
        </section>

		<section>
			<h3>core__init.class</h3>
			<ul>
				<li>Clojure core = clojure.core namespace <br/>~= JVM class file core__init.class</li>
				<span>
				<li>Decompiled core__init.class looks like this:</li>
				<small><pre style="width: 100%;"><code data-trim>
static { // Create vars and metadata (11/17%)
    __init0();
    __init1();
    // ...
    __init23();

    Compiler.pushNSandLoader(Class.forName("clojure.core__init").getClassLoader()); // (0%)
    try {
        load(); // Assign vars and metadata, load external functions (89/83%)
        Var.popThreadBindings(); // (0%)
    } finally {
        Var.popThreadBindings(); // (0%)
        throw finally;
    }
}
				</pre></code></small>
					</span>
			</ul>
			<span>
			<li>__init methods create vars + metadata</li>
			<small><pre style="width: 100%;"><code data-trim>
Var const__cons = RT.var("clojure.core", "cons");
AFn const__consMeta = RT.map(metaForCons);
				</pre></code></small>
			</span>
			</ul>
			<span>
			<li>load method assigns vars + metadata</li>
			<small><pre style="width: 100%;"><code data-trim>
const__cons.setMeta(const__consMeta);
const__cons.bindRoot(new core.cons());
				</pre></code></small>
			</span>
			</ul>
		</section>

		<section data-background="white">
			<h3>Clojure namespace</h3>
			<img class="normal-image" data-src="img/namespace_vars.svg" />

			<small>
				<ul>
					<li>Namespace: mapping from symbol to var (to value)</li>
				<span>
				<li>So if you use a function in your program:</li>
					<pre><code data-trim>
						(cons 1 '(2 3))
					</code></pre>
                </span>
				<span>
				<li>The decompiled JVM bytecode looks like this:</li>
					<pre><code data-trim>
						RT.var("clojure.core", "cons").getRawRoot().invoke(args);
					</code></pre>
                </span>
					<li>Note indirection: fetch namespace, fetch var, fetch value, invoke</li>
				</ul>
			</small>
		</section>
        </section>

		<section>
		<section>
			<h3>Why use dynamic vars? <span class="fragment">Clojure is <i>dynamic</i></span></h3>
			<ul>
				<li class="fragment">Dynamism is a Good Thing*</li>
				<li class="fragment">Dynamic vars (and namespaces) allow you to redefine variables at run time without recompiling</li>
				<li class="fragment">REPL-driven development
					<ul>
						<li class="fragment">Short feedback loops</li>
						<li class="fragment">Iterative testing</li>
						<li class="fragment">Develop software <i>while it's running</i></li>
					</ul>
				</li>
			</ul>
		</section>

		<section>
			<h3>Clojure dynamism</h3>
			<ul>
				<li><strike>Dynamic typing</strike>. Yes but no. We're not talking about that.</li>
				<li>Dynamic: available at run time (not just compile time)</li>
				<li>Clojure is dynamic because it lets you do more stuff at run time</li>
				<ul>
					<li>Dynamic binding</li>
					<li>+ <i>reified</i> language constructs</li>
					<li>+ dynamic compilation & evaluation</li>
					<li>--> Dynamic development (REPL)</li>
				</ul>
			</ul>
			<br />
			<br />
			<blockquote>
				Reification: turning a compiler detail into something you can play with at run time
			</blockquote>
		</section>

		<section>
			<p>Dynamic var binding</p>
					<pre><code data-trim>
; Create a Var and bind its root to the value 1
hello.core=> (def foo 1)
#'hello.core/foo
hello.core=> (def print-foo (fn [] (println foo)))
#'hello.core/print-foo

; Print by looking up runtime value of var
hello.core=> (print-foo)
1
nil
hello.core=> (def foo 2)
#'hello.core/foo

; It still works if we change the var value
hello.core=> (print-foo)
2
					</code></pre>
		</section>

		<section>
			<section>
				<p>Dynamic namespace binding</p>
					<pre><code data-trim>
; Create ns (compile to JVM class, load into JVM)
user=> (ns hello)
nil

; Compile function at run time to JVM class
; Insert it into existing namespace
hello=> (defn helloworld [] (println "Hey world!"))
#'hello/helloworld

; Execute normally
hello=> (helloworld)
Hey world!
nil

; Or call it manually using underlying JVM classes
hello=> (clojure.lang.RT/var "hello" "helloworld")
#'hello/helloworld
hello=> (.getRawRoot (clojure.lang.RT/var "hello" "helloworld"))
#&lt;hello$helloworld hello$helloworld@2b5071f6>
hello=> (.invoke (.getRawRoot (clojure.lang.RT/var "hello" "helloworld")))
Hey world!
nil
					</code></pre>
			</section>
			<section>
				<code data-trim><pre>
; Inspect reified namespace
; Symbol 'helloworld in namespace hello
; points to a Var with a root binding of
; our defined function
hello=> (ns-publics 'hello)
{helloworld #'hello/helloworld}
				</code></pre>
			</section>
		</section>
		</section>

				<section>
			<h3>REPL-driven development</h3>
			<small>
					<pre style="width: 100%;"><code class="clojure" style="width: 100%;">user=> (start-system)
Connected to mongo at localhost: grub-dev
Started server on localhost: 3000

user=> system
{:db-name "grub-dev"
 :db #&lt;DBApiLayer grub-dev&gt;
 :db-conn #&lt;MongoClient ...&gt;
 :port 3000
 :stop-server #&lt;clojure.lang.AFunction$1@7ed72ded&gt;,
 :states #&lt;Atom@610863a9:
   [{:tag 0
     :grubs { :grub-167afa69-f812-455a-bb8a-4b819236011a
                {:id "grub-167afa69-f812-455a-bb8a-4b819236011a"
                 :text "Milk"
                 :completed false}}}]&gt;}
user=> (reset! (:states system) [])
[]
user=> system
{ :db-name "grub-dev"
  :db #&lt;DBApiLayer grub-dev&gt;
  :db-conn #&lt;MongoClient ...&gt;
  :port 3000
  :stop-server #&lt;clojure.lang.AFunction$1@7ed72ded&gt;,
  :states #&lt;Atom@610863a9: []&gt;}
					</code></pre></small>
			<br/>
			<small><a href="http://thinkrelevance.com/blog/2013/06/04/clojure-workflow-reloaded">(Stuart Sierra "Reloaded" workflow)</a></small>
		</section>

		<section data-transition="slide" data-background="img/tesla.jpg" data-background-transition="zoom">
			<p style="position: absolute; top: 0; background-color: black;">Which is like swapping your engine while driving</p>
		</section>

		<section>
			<h3>But is dynamism always a Good Thing?</h3>
			<ul>
				<li class="fragment">The magic depends on dynamic binding</li>
				<li class="fragment">i.e. <i>somewhere</i> we need to set up namespaces and vars to point to the right things</li>
				<li class="fragment">Clojure does it on startup -> Slow startup</li>
			</ul>
		</section>

		<section>
			<p>So how can we make Clojure start <i>fast</i>?</p>
		</section>

		<section>
			<h3>Lean Clojure</h3>
			<ul>
				<li class="fragment blue">Idea: trade dynamic features for performance</li>
				<li class="fragment">Dynamism for development, not production</li>
				<li class="fragment">Drop:
					<ul>
						<li class="fragment">Dynamic binding of vars, namespaces</li>
						<li class="fragment">Dynamic compilation</li>
						<li class="fragment">Dynamic development</li>
					</ul>
				</li>
				<li class="fragment">Gain:
					<ul>
						<li class="fragment">Startup speed</li>
						<li class="fragment">Execution speed</li>
						<li class="fragment">Reduced memory usage</li>
					</ul>
				</li>
				</ul>
			</section>

		<section>
			<h3>Lean Clojure Projects: Oxcart and Skummet</h3>
			<ul>
				<li class="fragment">Google Summer of Code 2014</li>
				<li class="fragment">Oxcart</li>
				<ul>
					<li class="fragment">Based on experimental Clojure in Clojure compiler</li>
					<li class="fragment">Developed by Reid McKenzie</li>
					<li class="fragment">Compiles a limited subset of Clojure -> can't test</li>
				</ul>
				<li class="fragment">Skummet</li>
				<ul>
					<li class="fragment">Based on standard compiler</li>
					<li class="fragment">Developed by Alexander Yakushev</li>
					<li class="fragment">Changes:</li>
					<ul>
						<li class="fragment" style="font-weight: bold;">Mutable vars -> static class fields</li>
						<li class="fragment">(metadata trimming)</li>
						<li class="fragment">(no emission of macros)</li>
					</ul>
				</ul>
			</ul>
		</section>

		<section data-background="white">
			<h3>Skummet in one diagram</h3>
			<div>Clojure:</div>
			<img class="normal-image" style="max-width: 500px;" data-src="img/namespace_vars.svg" />
			<div>Skummet:</div>
			<img class="normal-image" style="max-width: 500px;" data-src="img/namespace_vars_lean.svg" />
		</section>

		<section>
			<h3>Skummet</h3>
			<ul>
				<li class="fragment">Main change: mutable vars -> static class fields</li>
				<li class="fragment">What we (hope to) get:
					<ul>
						<li class="fragment">Faster startup time from simpler loading process</li>
						<li class="fragment">Faster execution from fewer indirect calls</li>
						<span class="fragment">
						Old:
						<pre><code data-trim>
                        RT.var("clojure.core", "cons").getRawRoot().invoke(args);
						</code></pre>
                        </span>
						<span class="fragment">
						New:
						<pre><code data-trim>
							clojure.core$cons.invoke(args);
						</code></pre>
						</span>
					</ul>
				</li>
				<li class="fragment">What we lose:
					<ul>
						<li class="fragment">Dynamic binding (*except when we explicitly need it)</li>
						<li class="fragment">Dynamic evaluation (for lean code)</li>
						<li class="fragment">Dynamic development (for lean code)</li>
					</ul>
				</li>
			</ul>
		</section>

		<section>
			Does Skummet work?
		</section>

		<section>
			<h3>Benchmarks</h3>
			<ul>
				<li>5 tests from Computer Language Benchmarks Game</li>
				<ul>
					<li>+ hello benchmark (Hello World)</li>
					<li>+ dependencies benchmark</li>
				</ul>
				<li>Port to Android</li>
				<li>Run 30 times on Nexus 5, Nexus 7 for average</li>
				<li>Record <i>startup time</i> and <i>task time</i></li>
			</ul>
		</section>

		<section data-background="white">
			<h4>Benchmark startup times</h4>
			<img class="normal-image" data-src="img/benchmark_startup_times.png" />
		</section>

		<section data-background="white">
			<section>
				<h4>Benchmark total run times</h4>
				<br/>
				<img class="benchmarks-image" data-src="img/benchmarks1.png" />
				<img class="benchmarks-image" data-src="img/benchmarks2.png" />
				<img class="benchmarks-image" data-src="img/benchmarks3.png" />
				<img class="benchmarks-image" data-src="img/benchmarks4.png" />
            </section>
			<section>
				<div id="helloBenchmark2" class="diagram"></div>
			</section>
			<section>
				<div id="dependenciesBenchmark2" class="diagram"></div>
			</section>
			<section>
				<div id="binarytreesBenchmark2" class="diagram"></div>
			</section>
			<section>
				<div id="fannkuchreduxBenchmark2" class="diagram"></div>
			</section>
			<section>
				<div id="nbodyBenchmark2" class="diagram"></div>
			</section>
			<section>
				<div id="pidigitsBenchmark2" class="diagram"></div>
			</section>
			<section>
				<div id="spectralnormBenchmark2" class="diagram"></div>
			</section>
		</section>

		<section>
			<h3>Summary</h3>
			<ul>
                <li class="fragment">Clojure on Android starts slowly (2s minimum)</li>
				<li class="fragment">...even on ART (1.5s minimum)</li>
                <li class=fragment>...and it scales upwards quickly (deps benchmark: 2-2.7s)</li>
                <li class="fragment">Lean Clojure helps (~0.7s minimum)</li>
				<li class=fragment>...but it's not enough (Java: 0.1s minimum)</li>
            </ul>
		</section>
		<section>
			<h3>Possible further Lean Clojure changes</h3>
			<ul>
				<li class="fragment">Compile functions as static methods</li>
				<li class="fragment">Dependency shaking</li>
				<li class="fragment">Lazy var loading</li>
			</ul>
        </section>

		<section>
			<h3>Will I ever be able to use Clojure on Android?</h3>
			<img class="normal-image" data-src="img/clojure_plus_android.png" />
			</span>
			<h4 class="fragment">Yes, if:</h4>
			<ul>
				<li class="fragment">You don't care about startup time &rarr; use Clojure (now)</li>
				<li class="fragment">Lean Clojure is continued &rarr; use lean Clojure (sometime)</li>
				<li class="fragment">Wrapper framework + ClojureScript is OK <br/>&rarr; use ClojureScript (now)</li>
				<ul>
					<li class="fragment">React Native soon?</li>
				</ul>
			</ul>
		</section>

		<section>
			<h3>Thank you</h3>

			<small>Special thanks to my supervisor Jukka Nurminen and advisor Vesa Hirvisalo.</small>
			<br/>
			<br/>
			<h4>Thesis paper: thesis.ndk.io</h4>
			<h4>This presentation: thesis-pres.ndk.io</h4>
		</section>
	</div>

</div>

<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/lodash.js"></script>
<script src="js/highcharts.js"></script>
<script src="js/highcharts-more.js"></script>
<script src="js/diagrams.js"></script>
<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>

	// Full list of configuration options available at:
	// https://github.com/hakimel/reveal.js#configuration
	Reveal.initialize({
		controls: true,
		progress: true,
		history: true,
		center: true,

		transition: 'slide', // none/fade/slide/convex/concave/zoom

		// Optional reveal.js plugins
		dependencies: [
			{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
			{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
			{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
			{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
			{ src: 'plugin/zoom-js/zoom.js', async: true },
			{ src: 'plugin/notes/notes.js', async: true }
		]
	});

</script>

</body>
</html>
